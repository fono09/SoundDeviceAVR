;
.include	"m88def.inc"
;register
.def	NN0	=r16	;ノートナンバー0
.def	TC0	=r17	;音色0
.def	WV0	=r18	;波形値0
;
.def	NN1	=r19	;ノートナンバー1
.def	TC1	=r20	;音色1
.def	WV1	=r21	;波形値1
;
.def	SPK	=r22	;スピーカー出力値
;
.def	temp	=r23	;テンポラリレジスタ
.def	itemp	=r24	;割り込み内テンポラリレジスタ
.def	us_data	=r25	;USART送受信データ
;
;boudrate definition
.equ	BRH	=0x4
.equ	BRL	=0x11
.equ	ACK	=0x1
.equ	NACK	=0x0	
.equ	SAMPLES =0xFF
;
;vector area
	.cseg
	rjmp	reset   ;  reset vector
	reti            ;  INT0  vector
	reti		;  INT1  vector
	reti		;  PCINT0
	reti		;  PCINT1
	reti		;  PCINT2
	reti		;  WDT
	rjmp	t2cmp	;  Timer2 COMPA
	reti		;  Timer2 COMPB
	reti		;  Timer2 overflow
	reti		;  Timer1 capture
	rjmp	t1cmp	;  Timer1 COMPA
	reti		;  Timer1 COMPB
	reti		;  Timer1 overflow
	reti		;  Timer0 COMPA
	reti		;  Timer0 COMPB
	reti		;  Timer0 overflow
	reti		;  SPI STC
	rjmp	usartrx	;  USART/Rx complete
	reti		;  USART/ Data register empty
	reti		;  USART/Tx complete
	reti		;  ADC
	reti		;  EEPROM EE_RDY
	reti		;  Analog comparator
	reti		;  TWI
	reti		;  SPM_RDY
;
;Timer2 cmp
t2cmp:
	in	itemp, SREG
	push	itemp
	ld	WV1, Y+
	cpi	YH,high(tone*2+SAMPLES)
	brne	t2cmp_end
	cpi	YL,low(tone*2+SAMPLES)	
	brne	t2cmp_end
	ldi	SPK,0
	lsr	WV0
	add	SPK,WV0
	lsr	WV1
	add	SPK,WV1
	sts	OCR0A, SPK
	ldi	YH,high(tone*2)
	ldi	YL,low(tone*2)
t2cmp_end:
	pop	itemp
	out	SREG, itemp
	reti
;
;Timer1 cmp
t1cmp:
	in	itemp, SREG
	push	itemp
	pop	itemp
	out	SREG, itemp
	reti
;usart rx interrupt
usartrx:
	in	itemp, SREG
	push	itemp
	cli
	lds	us_data, UDR0
	st	X+, us_data
Txa:
	lds	itemp, UCSR0A
	sbrs	itemp, UDRE0
	rjmp	Txa
	sts	UDR0,  us_data
	cpi	us_data, 0x40 ;'@'
	brne	usartend
	ldi	XH, 0x01
	ldi	XL, 0x00
Txb:
	lds	itemp, UCSR0A
	sbrs	itemp, UDRE0
	rjmp 	Txb
	sts	UDR0, temp
	ld	temp, X+
	cpi	temp, 0x40 ;'@'
	brne	Txb
	ldi	XH, 0x01
	ldi	XL, 0x00
usartend:
	pop	itemp
	out	SREG, itemp
	sei
	reti
;
;reset routine
reset:
; set stuck pointer
	ldi	temp, high(RAMEND)
	out	SPH, temp
	ldi	temp, low(RAMEND)
	out	SPL, temp
; set DDRD
	ldi	temp, $FF
	out	DDRB, temp
	ldi	temp, $F0
	out	DDRD, temp
	ldi	temp, $FF
	out	PORTD, temp
; set Timer0 FastPWM
	ldi	temp, 0b10000011
	sts	TCCR0A, temp
	ldi	temp, 0b00001011
	sts	TCCR0B, temp
; set Timer1 CTC 
	ldi	temp, 0b00000000
	sts	TCCR1A, temp
	ldi	temp, 0b00001010
	sts	TCCR1B, temp
; set Timer2 CTC OCR2A compare interrupt enabled
	ldi	temp, 0b00000010
	sts	TCCR2A, temp
	ldi	temp, 0b00000101
	sts	TCCR2B, temp
; set default tone
	ldi	SPK, 0
	ldi	YH,high(tone*2)
	ldi	YL,low(tone*2)
;
;
	ldi	temp,BRH
	sts	UBRR0H,temp
	ldi	temp,BRL
	sts	UBRR0L,temp
	ldi	temp,0b10011000
	sts	UCSR0B,temp
	ldi	temp,0b00000110
	sts	UCSR0C,temp
	ldi	XH, 0x01
	ldi	XL, 0x00
	sei
;
;
;
main:
	rjmp	main
;
tone:
;正弦波
.db 0x80, 0x83, 0x86, 0x89, 0x8c, 0x8f, 0x92, 0x95
.db 0x98, 0x9c, 0x9f, 0xa2, 0xa5, 0xa8, 0xab, 0xae
.db 0xb0, 0xb3, 0xb6, 0xb9, 0xbc, 0xbf, 0xc1, 0xc4
.db 0xc7, 0xc9, 0xcc, 0xce, 0xd1, 0xd3, 0xd5, 0xd8
.db 0xda, 0xdc, 0xde, 0xe0, 0xe2, 0xe4, 0xe6, 0xe8
.db 0xea, 0xec, 0xed, 0xef, 0xf0, 0xf2, 0xf3, 0xf5
.db 0xf6, 0xf7, 0xf8, 0xf9, 0xfa, 0xfb, 0xfc, 0xfc
.db 0xfd, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff
.db 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe
.db 0xfd, 0xfc, 0xfc, 0xfb, 0xfa, 0xf9, 0xf8, 0xf7
.db 0xf6, 0xf5, 0xf3, 0xf2, 0xf0, 0xef, 0xed, 0xec
.db 0xea, 0xe8, 0xe6, 0xe4, 0xe2, 0xe0, 0xde, 0xdc
.db 0xda, 0xd8, 0xd5, 0xd3, 0xd1, 0xce, 0xcc, 0xc9
.db 0xc7, 0xc4, 0xc1, 0xbf, 0xbc, 0xb9, 0xb6, 0xb3
.db 0xb0, 0xae, 0xab, 0xa8, 0xa5, 0xa2, 0x9f, 0x9c
.db 0x98, 0x95, 0x92, 0x8f, 0x8c, 0x89, 0x86, 0x83
.db 0x80, 0x7c, 0x79, 0x76, 0x73, 0x70, 0x6d, 0x6a
.db 0x67, 0x63, 0x60, 0x5d, 0x5a, 0x57, 0x54, 0x51
.db 0x4f, 0x4c, 0x49, 0x46, 0x43, 0x40, 0x3e, 0x3b
.db 0x38, 0x36, 0x33, 0x31, 0x2e, 0x2c, 0x2a, 0x27
.db 0x25, 0x23, 0x21, 0x1f, 0x1d, 0x1b, 0x19, 0x17
.db 0x15, 0x13, 0x12, 0x10, 0xf, 0xd, 0xc, 0xa
.db 0x9, 0x8, 0x7, 0x6, 0x5, 0x4, 0x3, 0x3
.db 0x2, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0
.db 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x1
.db 0x2, 0x3, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8
.db 0x9, 0xa, 0xc, 0xd, 0xf, 0x10, 0x12, 0x13
.db 0x15, 0x17, 0x19, 0x1b, 0x1d, 0x1f, 0x21, 0x23
.db 0x25, 0x27, 0x2a, 0x2c, 0x2e, 0x31, 0x33, 0x36
.db 0x38, 0x3b, 0x3e, 0x40, 0x43, 0x46, 0x49, 0x4c
.db 0x4f, 0x51, 0x54, 0x57, 0x5a, 0x5d, 0x60, 0x63
.db 0x67, 0x6a, 0x6d, 0x70, 0x73, 0x76, 0x79, 0x7c
;三角波
.db 0x7f, 0x81, 0x83, 0x85, 0x87, 0x89, 0x8b, 0x8d
.db 0x8f, 0x91, 0x93, 0x95, 0x97, 0x99, 0x9b, 0x9d
.db 0x9f, 0xa1, 0xa3, 0xa5, 0xa7, 0xa9, 0xab, 0xad
.db 0xaf, 0xb1, 0xb3, 0xb5, 0xb7, 0xb9, 0xbb, 0xbd
.db 0xbf, 0xc1, 0xc3, 0xc5, 0xc7, 0xc9, 0xcb, 0xcd
.db 0xcf, 0xd1, 0xd3, 0xd5, 0xd7, 0xd9, 0xdb, 0xdd
.db 0xdf, 0xe1, 0xe3, 0xe5, 0xe7, 0xe9, 0xeb, 0xed
.db 0xef, 0xf1, 0xf3, 0xf5, 0xf7, 0xf9, 0xfb, 0xfd
.db 0xff, 0xfd, 0xfb, 0xf9, 0xf7, 0xf5, 0xf3, 0xf1
.db 0xef, 0xed, 0xeb, 0xe9, 0xe7, 0xe5, 0xe3, 0xe1
.db 0xdf, 0xdd, 0xdb, 0xd9, 0xd7, 0xd5, 0xd3, 0xd1
.db 0xcf, 0xcd, 0xcb, 0xc9, 0xc7, 0xc5, 0xc3, 0xc1
.db 0xbf, 0xbd, 0xbb, 0xb9, 0xb7, 0xb5, 0xb3, 0xb1
.db 0xaf, 0xad, 0xab, 0xa9, 0xa7, 0xa5, 0xa3, 0xa1
.db 0x9f, 0x9d, 0x9b, 0x99, 0x97, 0x95, 0x93, 0x91
.db 0x8f, 0x8d, 0x8b, 0x89, 0x87, 0x85, 0x83, 0x81
.db 0x7f, 0x7d, 0x7b, 0x79, 0x77, 0x75, 0x73, 0x71
.db 0x6f, 0x6d, 0x6b, 0x69, 0x67, 0x65, 0x63, 0x61
.db 0x5f, 0x5d, 0x5b, 0x59, 0x57, 0x55, 0x53, 0x51
.db 0x4f, 0x4d, 0x4b, 0x49, 0x47, 0x45, 0x43, 0x41
.db 0x3f, 0x3d, 0x3b, 0x39, 0x37, 0x35, 0x33, 0x31
.db 0x2f, 0x2d, 0x2b, 0x29, 0x27, 0x25, 0x23, 0x21
.db 0x1f, 0x1d, 0x1b, 0x19, 0x17, 0x15, 0x13, 0x11
.db 0xf, 0xd, 0xb, 0x9, 0x7, 0x5, 0x3, 0x1
.db 0x0, 0x2, 0x4, 0x6, 0x8, 0xa, 0xc, 0xe
.db 0x10, 0x12, 0x14, 0x16, 0x18, 0x1a, 0x1c, 0x1e
.db 0x20, 0x22, 0x24, 0x26, 0x28, 0x2a, 0x2c, 0x2e
.db 0x30, 0x32, 0x34, 0x36, 0x38, 0x3a, 0x3c, 0x3e
.db 0x40, 0x42, 0x44, 0x46, 0x48, 0x4a, 0x4c, 0x4e
.db 0x50, 0x52, 0x54, 0x56, 0x58, 0x5a, 0x5c, 0x5e
.db 0x60, 0x62, 0x64, 0x66, 0x68, 0x6a, 0x6c, 0x6e
.db 0x70, 0x72, 0x74, 0x76, 0x78, 0x7a, 0x7c, 0x7e
;
Hz:
.db 0x70
